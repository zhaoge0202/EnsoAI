name: Nightly Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          VERSION="${BASE_VERSION}-nightly.${DATE}.${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # å…ˆæž„å»º Vite äº§ç‰©ï¼Œå…±äº«ç»™æ‰€æœ‰å¹³å°
  build-app:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Build app
        run: pnpm build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            out/
            package.json
          retention-days: 1

  build-mac:
    needs: [prepare, build-app]
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-15
          - arch: x64
            runner: macos-15-large
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Restore pnpm cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-${{ matrix.arch }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-${{ matrix.arch }}-pnpm-

      - name: Restore Electron cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-${{ matrix.arch }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-${{ matrix.arch }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build macOS (${{ matrix.arch }})
        run: npx electron-builder --mac --${{ matrix.arch }} --publish never --config.mac.target=dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: |
            dist/*.dmg
            dist/*.yml
          retention-days: 7

      - name: Save pnpm cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-${{ matrix.arch }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Save Electron cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-${{ matrix.arch }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}

  build-windows:
    needs: [prepare, build-app]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Restore pnpm cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Restore Electron cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows
        run: npx electron-builder --win --x64 --publish never -c.win.target=nsis -c.win.target=portable

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: |
            dist/*.exe
            dist/*.yml
          retention-days: 7

      - name: Save pnpm cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Save Electron cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}

  build-linux:
    needs: [prepare, build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Restore pnpm cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Restore Electron cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Linux
        run: npx electron-builder --linux --x64 --publish never --config.linux.target=AppImage

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: |
            dist/*.AppImage
            dist/*.yml
          retention-days: 7

      - name: Save pnpm cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Save Electron cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}

  release:
    needs: [prepare, build-mac, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # å¤åˆ¶å®‰è£…åŒ…
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" \) -exec cp {} release/ \;

          # å¤åˆ¶ Windows å’Œ Linux çš„ yml æ–‡ä»¶
          cp artifacts/windows-x64/latest.yml release/ 2>/dev/null || true
          cp artifacts/linux-x64/latest-linux.yml release/ 2>/dev/null || true

          # åˆå¹¶ macOS çš„ yml æ–‡ä»¶ï¼ˆä¸¤ä¸ªæž¶æž„ï¼‰
          if [ -f "artifacts/mac-arm64/latest-mac.yml" ] && [ -f "artifacts/mac-x64/latest-mac.yml" ]; then
            # ä½¿ç”¨ arm64 çš„ä½œä¸ºåŸºç¡€ï¼Œæ·»åŠ  x64 çš„æ–‡ä»¶ä¿¡æ¯
            cp artifacts/mac-arm64/latest-mac.yml release/latest-mac.yml
            # æå– x64 çš„ files éƒ¨åˆ†å¹¶è¿½åŠ 
            grep -A3 "^  - url:" artifacts/mac-x64/latest-mac.yml >> release/latest-mac.yml
          elif [ -f "artifacts/mac-arm64/latest-mac.yml" ]; then
            cp artifacts/mac-arm64/latest-mac.yml release/
          elif [ -f "artifacts/mac-x64/latest-mac.yml" ]; then
            cp artifacts/mac-x64/latest-mac.yml release/
          fi

          ls -la release/

      - name: Delete existing nightly releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤æ‰€æœ‰ -nightly. æ ¼å¼çš„ releaseï¼ˆä½¿ç”¨ JSON æ ¼å¼èŽ·å–å‡†ç¡®çš„ tag åï¼‰
          gh release list --limit 100 --json tagName -q '.[].tagName' | grep -E '\-nightly\.' | while read tag; do
            echo "Deleting release: $tag"
            gh release delete "$tag" --yes --cleanup-tag || true
          done

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BASE_VERSION=$(echo "$VERSION" | cut -d'-' -f1)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
          TAG="v${BASE_VERSION}-nightly.${SHORT_SHA}"

          cat > notes.md << EOF
          ## ðŸŒ™ Nightly Build

          > âš ï¸ **è­¦å‘Š**: è¿™æ˜¯è‡ªåŠ¨æž„å»ºçš„å†…æµ‹ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½å’Œå·²çŸ¥é—®é¢˜ã€‚

          **ç‰ˆæœ¬**: \`${VERSION}\`
          **æäº¤**: [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})
          **æ¶ˆæ¯**: ${COMMIT_MSG}
          **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ---

          ## ðŸ“¦ ä¸‹è½½

          | å¹³å° | æ–‡ä»¶ |
          |------|------|
          | macOS (Apple Silicon) | [EnsoAI-${VERSION}-arm64.dmg](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}-arm64.dmg) |
          | macOS (Intel) | [EnsoAI-${VERSION}.dmg](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}.dmg) |
          | Windows (x64 å®‰è£…ç‰ˆ) | [EnsoAI-Setup-${VERSION}.exe](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-Setup-${VERSION}.exe) |
          | Windows (x64 ä¾¿æºç‰ˆ) | [EnsoAI-${VERSION}-portable.exe](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}-portable.exe) |
          | Linux (x64) | [EnsoAI-${VERSION}.AppImage](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}.AppImage) |

          > âš ï¸ **macOS ç”¨æˆ·æ³¨æ„**: ç”±äºŽåº”ç”¨æœªç­¾åï¼Œé¦–æ¬¡æ‰“å¼€å¯èƒ½æç¤º"å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
          > \`\`\`bash
          > sudo xattr -dr com.apple.quarantine /Applications/EnsoAI.app
          > \`\`\`
          EOF

          gh release create "$TAG" \
            --title "Nightly Build (${SHORT_SHA})" \
            --notes-file notes.md \
            --prerelease \
            --latest=false \
            --target ${{ github.sha }} \
            release/*
